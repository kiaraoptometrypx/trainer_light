<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.5=" />

<title>Fan Chart with Fogging & CYL Blur</title>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    font-family: Arial;
    font-size: 15px;
    color: #404040;
    height: 100vh;
    justify-content: center;
    background: lightgrey;
  }

  #header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
  }

  #container {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  #left-controls, #right-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  #cylVal { font-weight: bold; margin-left:5px; }

  button {
    border: 2px solid grey;
    font-size: 15px;
    padding: 2px;
    height: 50px;
    width: 100px;
    border-radius: 10px;
    color: #404040;
    margin-top: 5px;
    margin-bottom: 5px;
    user-select:none;
    font-weight:600;

  }

  .smallbtn {
    border: 2px solid grey;
    font-size: 15px;
    padding: 2px;
    height: 25px;
    width: 100px;
    border-radius: 10px;
    color: #404040;
    margin-top: 5px;
    margin-bottom: 5px;
    user-select:none;
  }

#fan-wrapper {
  display: inline-flex;   /* key */
  width: 500px;
  height: 450px;
  background-image: url("https://raw.githubusercontent.com/kiaraoptometrypx/trainer_light/main/FCBG.jpg");
  background-size: cover;       
  background-position: center;  
  background-repeat: no-repeat;
  position: relative;
  display: flex;
  justify-content: center;     
  align-items: center;         
  overflow: hidden;            
  border-radius: 50px;          
}

#fan-container {
  width: 450px;       /* fan smaller than wrapper */
  height: 450px;
  background: transparent;
  display: block;
  margin-top: 40px;   
  margin-left: 5px;
}

#page-wrapper {
  display: inline-flex;   /* key */
  justify-content: center;    
  max-width: 100%;
  flex-direction: column;
  align-items: center;
}

.bg-dc {
  width: 500px;
  height: 300px;
  background-image: url("https://raw.githubusercontent.com/kiaraoptometrypx/trainer_light/main/DCBG.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  margin: 0 auto;
  border-radius:50px;
}

#dc-container{
  display: inline-flex;   /* key */
  align-items:center;
  gap:20px;
  max-width:80%;
  justify-content: center;    
}

.dc-controls{
  display:flex;
  flex-direction:column;
  gap:20px;
}


</style>
</head>

<body>

<div style="max-width:80%">

<table>
<tr style="height:1000px"><td>
</td></tr>


<tr>
<td align="center" style="text-align:center;">

<div style="text-align:center; margin-top:500px; margin-bottom:100px">
<span style="font-size:25px"><b>Kiara Optometry Refraction Helper</b></span>


<div style="height:60px"></div>



<span><b>Which type of duochrome vision do you see?</b></span><br>


<div style="margin-top:20px" id="header">
  <span style="font-size:25px"><b>SPH Value Correction <span id="dcHint">0.00</span></span>

</div>

<div style="height:20px"></div>

<div id="dc-container">
  
  <!-- Left controls -->
  <div class="dc-controls">
    <button class="button" onclick="selectDC(1)">1</button>
    <button class="button" onclick="selectDC(2)">2</button>
  </div>

  <!-- Center image -->
  <div class="bg-dc"></div>

  <!-- Right controls -->
  <div class="dc-controls">
    <button class="button" onclick="selectDC(3)">3</button>
    <button class="button" onclick="selectDC(4)">4</button>
  </div>

</div>




</div>

</td></tr>




<tr>
<td align="center" style="text-align:center;">

  <div id="page-wrapper">



<span><b>Adjust the rotation and line darkness to match what you see.</b></span>

<div style="margin-top:20px" id="header">
  <span style="font-size:25px"><b>CYL Value Correction<span style="color:darkred" id="cylVal">0.00</span></b></span>
</div>
<div style="height:20px"></div>


<div id="container">
  <div id="left-controls">


    <div>
      <b>Line</b><br>
      <button onclick="changeCyl(-0.25)">Lighter</button>
    </div>
    <div>
      <b>Rotate</b><br>
      <button onclick="rotateFan(-45)"><<<</button><br>
      <button onclick="rotateFan(-15)"><<</button><br>
      <button onclick="rotateFan(-7.5)"><</button>
    </div>
  </div>

  <!-- Fan wrapper -->
  <div id="fan-wrapper">
    <canvas id="fan-container" width="500" height="500"></canvas>
  </div>

  <div id="right-controls">

<div style="display:none">
<b>All Lines</b><br>
  <button id="fogBtn" onclick="toggleFogging()">Lighter</button>
</div>

    <div>
      <b>Line</b><br>
      <button onclick="changeCyl(0.25)">Darker</button>
    </div>
    <div>
      <b>Rotate</b><br>
      <button onclick="rotateFan(45)">>>></button><br>
      <button onclick="rotateFan(15)">>></button><br>
      <button onclick="rotateFan(7.5)">></button>
    </div>
  </div>
</div>

</div>

</td></tr>

<tr style="height:500px"><td>
</td></tr>

</table>


</div>





<script>
const canvas = document.getElementById('fan-container');
const ctx = canvas.getContext('2d');

/* ===== State ===== */
let cylBlur = 0.00;
let fogOn = true;
let fogStrength = 0.0;
let angle = 0;

const cylVal = document.getElementById('cylVal');
const fogBtn = document.getElementById('fogBtn');

/* ===== Display ===== */
function updateCylDisplay() {
  let axis = angle % 180;
  if (axis === 0) axis = 180;
  cylVal.textContent = `- ${cylBlur.toFixed(2)} Ã— ${axis.toString().padStart(3,'0')}`;
}
updateCylDisplay();

/* ===== Controls ===== */
function toggleFogging() {
  fogOn = !fogOn;
  fogBtn.textContent = fogOn ? 'Lighter' : 'Darker';
  drawFan();
}

function changeCyl(delta) {
  cylBlur = Math.max(0, +(cylBlur + delta).toFixed(2));
  updateCylDisplay();
  drawFan();
}

function rotateFan(delta) {
  angle = (angle + delta + 360) % 360;
  updateCylDisplay();
  drawFan();
}

/* ===== Draw ===== */
function drawFan() {
  const cw = canvas.width;
  const ch = canvas.height;
  const cx = cw / 2;
  const cy = ch / 2;

  const outerR = cw * 0.29;
  const innerR = cw * 0.075;
  const lineLen = cw * 0.25;
  const dotOffset = cw * 0.275;

  ctx.clearRect(0, 0, cw, ch);

  /* Outer white circle */
  ctx.beginPath();
  ctx.arc(cx, cy, outerR, 0, Math.PI * 2);
  ctx.fillStyle = 'white';
  ctx.fill();

  ctx.save();
  ctx.translate(cx, cy);

  const fanAngles = [0,15,30,45,60,75,90,105,120,135,150,165];

  fanAngles.forEach(a => {

    // ðŸ”‘ blur relative to rotating axis (fan stays fixed)
    const rel = Math.abs(((a - angle + 90) % 180) - 90);
    const rawBlur = (rel / 90) * (cylBlur * 2) + (fogOn ? fogStrength : 0);
    const layers = Math.max(1, Math.round(Math.min(rawBlur, 6) * 6));

    for (let i = 0; i < layers; i++) {
      ctx.save();
      ctx.rotate(a * Math.PI / 180);

      ctx.lineWidth = 3.2;
      ctx.strokeStyle = `rgba(84,84,84,${1 / layers})`;

      ctx.beginPath();
      ctx.moveTo(i - layers / 2, -lineLen);
      ctx.lineTo(i - layers / 2,  lineLen);
      ctx.stroke();

      ctx.restore();
    }
  });

  ctx.restore();

  /* Axis dots (rotate only these) */
  [0, 180].forEach(a => {
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate((a + angle) * Math.PI / 180);

    ctx.beginPath();
    ctx.arc(0, -dotOffset, 4, 0, Math.PI * 2);
    ctx.fillStyle = 'darkred';
    ctx.fill();

    ctx.restore();
  });

  /* Center white circle */
  ctx.beginPath();
  ctx.arc(cx, cy, innerR, 0, Math.PI * 2);
  ctx.fillStyle = 'white';
  ctx.fill();
}

drawFan();
</script>




<script>
function selectDC(val){
  const dcHint = document.getElementById("dcHint");

  switch(val){
    case 1:
      dcHint.textContent = "-0.50";
      dcHint.style.color = "darkred";
      break;
    case 2:
      dcHint.textContent = "-0.25";
      dcHint.style.color = "darkred";
      break;
    case 3:
      dcHint.textContent = "+0.25";
      dcHint.style.color = "darkblue";
      break;
    case 4:
      dcHint.textContent = "+0.50";
      dcHint.style.color = "darkblue";
      break;
  }
}
</script>







</body>
</html>
